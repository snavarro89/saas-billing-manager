// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  CUSTOM
}

enum CustomerType {
  NORMAL
  STRATEGIC
  TRIAL
}

enum PeriodOrigin {
  PAYMENT
  TRIAL
  MANUAL_EXTENSION
}

enum PeriodStatus {
  ACTIVE
  EXPIRING
  EXPIRED
}

enum BillingStatus {
  PENDING
  INVOICED
  NOT_APPLICABLE
}

enum PaymentStatus {
  CONFIRMED
  REVERTED
}

enum OperationalStatus {
  ACTIVE
  ACTIVE_WITH_PENDING_PAYMENT
  PENDING_RENEWAL
  SUSPENDED
  LOST
}

enum RelationshipStatus {
  ACTIVE
  UNDER_FOLLOW_UP
  SUSPENDED_NON_PAYMENT
  SUSPENDED_NEGOTIATION
  CANCELLED_VOLUNTARILY
  LOST_NO_RESPONSE
  ELIGIBLE_FOR_DELETION
}

enum InvoiceStatus {
  PENDING
  GENERATED
  PAID
  CANCELLED
}

enum PlanType {
  PER_USER
  USAGE_BASED
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String?  @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id             String  @id @default(cuid())
  commercialName String
  alias          String?
  adminContact   String?
  billingContact String?
  notes          String?

  // Fiscal identity (informative only)
  legalName    String?
  rfc          String?
  fiscalRegime String?
  cfdiUsage    String?
  billingEmail String?

  // Status fields
  operationalStatus  OperationalStatus?  @default(ACTIVE)
  relationshipStatus RelationshipStatus? @default(ACTIVE)

  // Invoice settings
  invoiceRequired Boolean @default(false)

  // Soft delete
  isDeleted Boolean @default(false)

  // Relations
  agreements     CommercialAgreement[]
  servicePeriods ServicePeriod[]
  payments       Payment[]
  invoices       Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([operationalStatus])
  @@index([relationshipStatus])
  @@index([isDeleted])
}

model CommercialAgreement {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  subtotalAmount  Float
  currency        String       @default("MXN")
  description     String?
  billingCycle    BillingCycle
  renewalDay      Int // Day of month (1-31)
  gracePeriodDays Int          @default(0)
  customerType    CustomerType @default(NORMAL)
  specialRules    String?

  isActive  Boolean   @default(true)
  startDate DateTime  @default(now())
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([isActive])
}

model ServicePeriod {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  startDate            DateTime
  endDate              DateTime
  origin               PeriodOrigin
  status               PeriodStatus  @default(ACTIVE)
  subtotalAmount       Float
  currency             String        @default("MXN")
  billingStatus        BillingStatus @default(PENDING)
  suggestedInvoiceDate DateTime?
  notes                String?

  // Plan fields
  planId        String?
  plan          Plan?      @relation(fields: [planId], references: [id], onDelete: SetNull)
  planSnapshot  Json?      // Snapshot of plan details at time of creation
  quantity      Float?     // Quantity/units for per-user plans
  frequency     BillingCycle? // Frequency selected for this period

  // Relations
  paymentPeriods PaymentPeriod[]
  invoice        Invoice?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([endDate])
  @@index([billingStatus])
}

model Payment {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  paymentDate   DateTime      @default(now())
  amount        Float
  currency      String        @default("MXN")
  method        String
  reference     String?
  screenshotUrl String? // URL/location of payment screenshot
  invoiceId     String? // Optional link to invoice this payment covers
  invoice       Invoice?      @relation("PaymentInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)
  status        PaymentStatus @default(CONFIRMED)
  notes         String?

  // Relations
  paymentPeriods PaymentPeriod[]
  paidInvoices   Invoice[]       @relation("InvoicePayment")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([paymentDate])
  @@index([status])
}

model PaymentPeriod {
  id              String        @id @default(cuid())
  paymentId       String
  payment         Payment       @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  servicePeriodId String
  servicePeriod   ServicePeriod @relation(fields: [servicePeriodId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([paymentId, servicePeriodId])
  @@index([paymentId])
  @@index([servicePeriodId])
}

model Invoice {
  id              String        @id @default(cuid())
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  servicePeriodId String        @unique
  servicePeriod   ServicePeriod @relation(fields: [servicePeriodId], references: [id], onDelete: Cascade)

  invoiceNumber  String? // External invoice number (from ERP/SAT) - alphanumeric
  invoiceUrl     String? // URL/location of the generated invoice
  status         InvoiceStatus @default(PENDING)
  subtotalAmount Float
  taxAmount      Float         @default(0)
  totalAmount    Float
  currency       String        @default("MXN")

  generatedDate   DateTime? // When invoice was generated externally
  paidDate        DateTime? // When invoice was marked as paid
  paidByPaymentId String? // Payment that paid this invoice
  paidByPayment   Payment?  @relation("InvoicePayment", fields: [paidByPaymentId], references: [id], onDelete: SetNull)

  notes String?

  // Relations
  payments Payment[] @relation("PaymentInvoice") // Payments linked to this invoice

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([servicePeriodId])
  @@index([status])
  @@index([createdAt])
}

model Plan {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  type        PlanType
  isActive    Boolean  @default(true)
  conditions  String?

  // Relations
  pricing     PlanPricing[]
  usageLimits PlanUsageLimit[]
  servicePeriods ServicePeriod[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([type])
}

model PlanPricing {
  id       String      @id @default(cuid())
  planId   String
  plan     Plan        @relation(fields: [planId], references: [id], onDelete: Cascade)
  frequency BillingCycle
  price    Float
  currency String      @default("MXN")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, frequency])
  @@index([planId])
}

model PlanUsageLimit {
  id         String  @id @default(cuid())
  planId     String
  plan       Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  concept    String  // e.g., "# of services", "Storage", "IA Usage"
  limitValue Float?  // Numeric limit value (null for "None")
  unit       String? // e.g., "GB", "users", "services"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
}
